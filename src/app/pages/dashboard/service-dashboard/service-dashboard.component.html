<div class="p-6 space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Recent Orders</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage and track all maintenance orders</p>
        </div>

        <!-- Filter Button -->
        <div class="relative" (keydown.escape)="open=false">
            <button (click)="toggleDropdown($event)" class="inline-flex items-center gap-2 rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 transition-all dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-750" aria-haspopup="listbox" [attr.aria-expanded]="open">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                <span>{{ selected.size ? (selected.size + ' filters applied') : 'Filter options' }}</span>
                <svg class="w-4 h-4 transition-transform" [class.rotate-180]="open" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>

            <!-- Dropdown Menu -->
            <div *ngIf="open" class="absolute right-0 top-full z-[999] mt-2 w-80 rounded-xl border border-gray-200 bg-white shadow-xl dark:border-gray-700 dark:bg-gray-800" (click)="$event.stopPropagation()" role="listbox">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-900 dark:text-white">Filters</h3>
                        <div class="flex gap-2">
                            <button type="button" (click)="selectAll()" class="text-xs text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 font-medium">Select all</button>
                            <span class="text-gray-300 dark:text-gray-600">|</span>
                            <button type="button" (click)="clearAll()" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 font-medium">Clear</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 max-h-80 overflow-y-auto">
                    <div class="space-y-2">
                        <label *ngFor="let opt of options; trackBy: trackByKey" class="flex items-center gap-3 rounded-lg px-3 py-2.5 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors group">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 dark:border-gray-600 dark:bg-gray-700" [checked]="isChecked(opt.key)" (change)="toggle(opt.key, $event)" />
                            <span class="text-sm text-gray-700 dark:text-gray-200 group-hover:text-gray-900 dark:group-hover:text-white">{{ opt.label }}</span>
                        </label>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                    <button type="button" (click)="open=false" class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors dark:text-gray-300 dark:hover:bg-gray-700">Cancel</button>
                    <button type="button" (click)="apply()" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors shadow-sm">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table Card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-700">
                <tr>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Vehicle</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Center</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Service Type</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Appointment</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Technician</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
                </thead>

                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                <tr *ngFor="let item of tickets" class="hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center text-white font-semibold">{{ item.customerName ? item.customerName.charAt(0).toUpperCase() : 'U' }}</div>
                            <div class="ml-3"><div class="text-sm font-medium text-gray-900 dark:text-white">{{ item.customerName }}</div></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ item.carName }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ item.licensePlate }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-700 dark:text-gray-300">{{ item.centerName }}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">{{ getService(item) }}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 dark:text-white">{{ item.scheduleTime }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ item.scheduleDate | date: 'dd MMM yyyy' }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-700 dark:text-gray-300">{{ item.technicianName || 'Unassigned' }}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold" [ngClass]="{'bg-yellow-100 text-yellow-700': item.status === 'CUSTOMER_SUBMITTED', 'bg-blue-100 text-blue-700': item.status === 'TECHNICIAN_RECEIVED', 'bg-purple-100 text-purple-700': item.status === 'TECHNICIAN_COMPLETED', 'bg-emerald-100 text-emerald-700': item.status === 'DONE'}">
                            <span class="w-1.5 h-1.5 rounded-full mr-1.5" [ngClass]="{'bg-yellow-600': item.status === 'CUSTOMER_SUBMITTED', 'bg-blue-600': item.status === 'TECHNICIAN_RECEIVED', 'bg-purple-600': item.status === 'TECHNICIAN_COMPLETED', 'bg-emerald-600': item.status === 'DONE'}"></span>
                            {{ getStatus(item.status) }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <button (click)="onDetail(item.id, item.carModelId, item.numOfKm, item.technicianId, item.scheduleId, item.isMaintenance, item.isRepair)" title="Edit Service" class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></svg>
                            </button>

                            <!-- COMPLETE (Chỉ Technician) -->
                            <button *ngIf="item.status === 'TECHNICIAN_RECEIVED' && item.isMaintenance && !isStaff" (click)="onComplete(item.id)" title="Mark as Complete" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-900/20 dark:text-emerald-400 dark:hover:bg-emerald-900/30 transition-colors">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                Complete
                            </button>

                            <!-- HANDOVER (Chỉ Staff - Khi Tech đã Complete) -->
                            <button *ngIf="item.status === 'TECHNICIAN_COMPLETED' && isStaff" (click)="onDeliver(item.id)" title="Handover to Customer" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:hover:bg-blue-900/30 transition-colors border border-blue-200 dark:border-blue-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11.536 19.464a4.335 4.335 0 00-3.232.975 3.915 3.915 0 00-1.028 2.868l-.286.86a.5.5 0 01-.95-.317l.286-.858a4.915 4.915 0 011.288-3.601 5.335 5.335 0 014.06-1.222l2.463-4.617A5.979 5.979 0 0115 7z" /></svg>
                                Handover
                            </button>

                            <!-- Cancel -->
                            <button *ngIf="item.isMaintenance && item.status !== 'DONE'" (click)="onCancel(item.id)" title="Cancel Order" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30 transition-colors">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                Cancel
                            </button>

                            <span *ngIf="!item.isMaintenance" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                Cancelled
                            </span>

                            <button *ngIf="!item.isMaintenance" (click)="onReopen(item.id)" title="Reactivate Order" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:hover:bg-blue-900/30 transition-colors">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                Reopen
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <div *ngIf="tickets.length === 0" class="flex flex-col items-center justify-center py-16 px-4">
                <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">No orders found</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">Try adjusting your filters or clearing them to see more results.</p>
            </div>
        </div>
    </div>
</div>